<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h2 {
            margin-top: 20px;
        }
        label {
            display: block;
            margin: 10px 0 5px;
        }
        input, textarea {
            width: 100%;
            max-width: 500px;
            padding: 8px;
        }
        button {
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #000;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        #preview, #featurePreview, #learnMorePreview {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
        }
        img {
            max-width: 100px;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>Admin Dashboard</h1>

    <h2>Style Settings</h2>
    <label for="font">Font (e.g., Arial, sans-serif):</label>
    <input type="text" id="font" oninput="updatePreview()">
    <label for="fontSize">Font Size (e.g., 16):</label>
    <input type="number" id="fontSize" oninput="updatePreview()">
    <label for="featureImage">Feature Photo URL (e.g., https://example.com/feature.png):</label>
    <input type="text" id="featureImage" oninput="updateFeaturePreview()">

    <h2>Feature Photo Preview</h2>
    <div id="featurePreview"></div>

    <h2>Text Preview</h2>
    <div id="preview">Preview text will appear here.</div>

    <h2>Sentence Template</h2>
    <textarea id="template" rows="4" cols="50">
My favorite clothing brand is [brand] and it is owned by [owner] and their average garment is produced for $[avg_cost] by [labor_conditions] workers in [country].
    </textarea>

    <h2>Google Sheets URL</h2>
    <label for="sheetUrl">Paste Google Sheets URL:</label>
    <input type="text" id="sheetUrl" placeholder="e.g., https://docs.google.com/spreadsheets/d/...">
    <button onclick="fetchSheetData()">Load Sheet Data</button>

    <h2>Brand Data (JSON)</h2>
    <textarea id="data" rows="10" cols="50"></textarea>

    <h2>Learn More Image Override</h2>
    <label for="overrideLearnMoreImage">Override Learn More Image URL:</label>
    <input type="text" id="overrideLearnMoreImage" oninput="updateLearnMorePreview()">
    <label for="uploadLearnMoreImage">Upload Learn More Image URL:</label>
    <input type="text" id="uploadLearnMoreImage" oninput="updateLearnMorePreview()">
    <button onclick="clearOverride()">Clear Override</button>

    <h2>Learn More Image Preview</h2>
    <div id="learnMorePreview"></div>

    <button onclick="saveData()">Save All Changes</button>

    <script>
        async function fetchData() {
            const response = await fetch('data.json');
            return await response.json();
        }

        async function loadData() {
            const data = await fetchData();
            document.getElementById('font').value = data.font || '';
            document.getElementById('fontSize').value = data.fontSize || '';
            document.getElementById('featureImage').value = data.featureImage || '';
            document.getElementById('template').value = data.template || '';
            document.getElementById('data').value = JSON.stringify(data.brands, null, 2);
            document.getElementById('overrideLearnMoreImage').value = data.overrideLearnMoreImage || '';
            document.getElementById('uploadLearnMoreImage').value = '';
            updatePreview();
            updateFeaturePreview();
            updateLearnMorePreview();
        }

        function updatePreview() {
            const font = document.getElementById('font').value;
            const fontSize = document.getElementById('fontSize').value;
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            preview.style.fontFamily = font || 'Arial, sans-serif';
            preview.style.fontSize = fontSize ? fontSize + 'px' : '16px';
            preview.innerText = "Preview text will appear here.";
        }

        function updateFeaturePreview() {
            const featureImage = document.getElementById('featureImage').value;
            const preview = document.getElementById('featurePreview');
            preview.innerHTML = '';
            if (featureImage) {
                const img = document.createElement('img');
                img.src = featureImage;
                preview.appendChild(img);
            }
        }

        function updateLearnMorePreview() {
            const overrideImage = document.getElementById('overrideLearnMoreImage').value;
            const uploadImage = document.getElementById('uploadLearnMoreImage').value;
            const preview = document.getElementById('learnMorePreview');
            preview.innerHTML = '';
            const imageToShow = uploadImage || overrideImage;
            if (imageToShow) {
                const img = document.createElement('img');
                img.src = imageToShow;
                preview.appendChild(img);
            }
        }

        function clearOverride() {
            document.getElementById('overrideLearnMoreImage').value = '';
            updateLearnMorePreview();
        }

        async function fetchSheetData() {
            const sheetUrl = document.getElementById('sheetUrl').value;
            if (!sheetUrl) {
                alert('Please enter a Google Sheets URL.');
                return;
            }
            const sheetIdMatch = sheetUrl.match(/\/d\/(.+?)\//);
            if (!sheetIdMatch) {
                alert('Invalid Google Sheets URL.');
                return;
            }
            const sheetId = sheetIdMatch[1];
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;
            try {
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                const json = csvToJson(csvText);
                document.getElementById('data').value = JSON.stringify(json, null, 2);
                alert('Sheet data loaded successfully.');
            } catch (e) {
                alert('Error loading sheet. Ensure itâ€™s shared publicly and formatted correctly.');
            }
        }

        function csvToJson(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
            const expectedHeaders = ['brand', 'owner', 'country', 'avg cost', 'labor conditions', 'image'];
            if (!expectedHeaders.slice(0, 5).every((h, i) => headers[i] === h)) {
                throw new Error('Header mismatch');
            }
            const brands = {};
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"|"$/g, ''));
                if (values.length >= 5 && values[0]) {
                    brands[values[0]] = {
                        owner: values[1],
                        country: values[2],
                        avg_cost: parseFloat(values[3]) || 0,
                        labor_conditions: values[4],
                        image: values[5] || ''
                    };
                }
            }
            return brands;
        }

        function saveData() {
            const font = document.getElementById('font').value;
            const fontSize = document.getElementById('fontSize').value;
            const featureImage = document.getElementById('featureImage').value;
            const template = document.getElementById('template').value;
            const brandsText = document.getElementById('data').value;
            const overrideLearnMoreImage = document.getElementById('overrideLearnMoreImage').value || document.getElementById('uploadLearnMoreImage').value;
            try {
                const brands = JSON.parse(brandsText);
                const data = {
                    font: font,
                    fontSize: fontSize,
                    featureImage: featureImage,
                    template: template,
                    brands: brands,
                    overrideLearnMoreImage: overrideLearnMoreImage
                };
                alert('Copy the JSON below and paste it into data.json on GitHub:\n\n' + JSON.stringify(data, null, 2));
            } catch (e) {
                alert('Invalid JSON format in brand data: ' + e.message);
            }
        }

        loadData();
    </script>
</body>
</html>